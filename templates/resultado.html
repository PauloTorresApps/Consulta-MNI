{% extends "base.html" %}

{% block title %}Processo {{ numero_processo }}{% endblock %}

{% block page_header %}
<div class="row mb-2">
    <div class="col-sm-6">
        <h1 class="m-0">Processo {{ numero_processo }}</h1>
    </div>
    <div class="col-sm-6">
        <ol class="breadcrumb float-sm-right">
            <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
            <li class="breadcrumb-item active">Resultado</li>
        </ol>
    </div>
</div>
{% endblock %}

{% block content %}
{# Seção de Movimentos com Documentos Vinculados #}
{% if resultado.processo and resultado.processo.movimento %}
<div class="row">
    <div class="col-md-12">
        <div class="card card-primary">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-file-alt"></i> Movimentos com Documentos
                </h3>
            </div>
            
            <div class="card-body">
                {% if resultado.processo.movimento is mapping %}
                    {% set movimentos = [resultado.processo.movimento] %}
                {% else %}
                    {% set movimentos = resultado.processo.movimento %}
                {% endif %}
                
                {# Criar dicionário de documentos para busca rápida #}
                {% set documentos_dict = {} %}
                {% if resultado.processo.documento %}
                    {% if resultado.processo.documento is mapping %}
                        {% set _ = documentos_dict.update({resultado.processo.documento.idDocumento: resultado.processo.documento}) %}
                    {% else %}
                        {% for doc in resultado.processo.documento %}
                            {% set _ = documentos_dict.update({doc.idDocumento: doc}) %}
                        {% endfor %}
                    {% endif %}
                {% endif %}
                
                {# Filtrar apenas movimentos com documentos vinculados #}
                {% set movimentos_com_docs = [] %}
                {% for mov in movimentos %}
                    {% if mov.idDocumentoVinculado %}
                        {% set _ = movimentos_com_docs.append(mov) %}
                    {% endif %}
                {% endfor %}
                
                {% if movimentos_com_docs %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Total de movimentos com documentos:</strong> {{ movimentos_com_docs|length }}
                    </div>
                    
                    <div class="movimento-timeline">
                        {% for mov in movimentos_com_docs %}
                        <div class="movimento-item">
                            <div class="movimento-marker"></div>
                            
                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            {% if mov.idMovimento %}
                                                <strong class="text-primary">
                                                    <i class="fas fa-hashtag"></i> {{ mov.idMovimento }}
                                                </strong>
                                                {% if mov.movimentoLocal and mov.movimentoLocal.descricao %}
                                                    - {{ mov.movimentoLocal.descricao }}
                                                {% elif mov.descricao %}
                                                    - {{ mov.descricao }}
                                                {% endif %}
                                            {% endif %}
                                            
                                            {% if mov.tipoMovimento %}
                                                <span class="badge badge-secondary ml-2">{{ mov.tipoMovimento }}</span>
                                            {% endif %}
                                        </div>
                                        
                                        {% if mov.dataHora %}
                                            <small class="text-muted">
                                                <i class="far fa-calendar-alt"></i> {{ mov.dataHora }}
                                            </small>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="card-body">
                                    {# Documentos Vinculados #}
                                    {% if mov.idDocumentoVinculado is string or mov.idDocumentoVinculado is number %}
                                        {% set docs_vinculados = [mov.idDocumentoVinculado] %}
                                    {% else %}
                                        {% set docs_vinculados = mov.idDocumentoVinculado %}
                                    {% endif %}
                                    
                                    <h6 class="mb-3">
                                        <i class="fas fa-paperclip"></i> Documentos Anexados:
                                    </h6>
                                    
                                    <div class="list-group">
                                        {% for id_doc in docs_vinculados %}
                                        {% set doc_info = documentos_dict.get(id_doc|string) %}
                                        <div class="list-group-item">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div class="flex-grow-1">
                                                    {% if doc_info %}
                                                        {# Buscar valor do rotulo em outroParametro #}
                                                        {% set rotulo = namespace(valor='') %}
                                                        {% if doc_info.outroParametro %}
                                                            {% for param in doc_info.outroParametro %}
                                                                {% if param.nome == 'rotulo' %}
                                                                    {% set rotulo.valor = param.valor %}
                                                                {% endif %}
                                                            {% endfor %}
                                                        {% endif %}
                                                        
                                                        <h6 class="mb-1">
                                                            <i class="far fa-file-pdf"></i>
                                                            {% if rotulo.valor %}
                                                                {{ rotulo.valor }}
                                                            {% elif doc_info.descricao %}
                                                                {{ doc_info.descricao }}
                                                            {% else %}
                                                                Documento {{ id_doc }}
                                                            {% endif %}
                                                        </h6>
                                                        <small class="text-muted">ID: {{ id_doc }}</small>
                                                    {% else %}
                                                        <h6 class="mb-1">
                                                            <i class="far fa-file"></i> Documento {{ id_doc }}
                                                        </h6>
                                                    {% endif %}
                                                </div>
                                                
                                                <div>
                                                    <form method="POST" action="{{ url_for('download_documento') }}" style="display: inline;">
                                                        <input type="hidden" name="numero_processo" value="{{ numero_processo }}">
                                                        <input type="hidden" name="id_documento" value="{{ id_doc }}">
                                                        <input type="hidden" name="id_movimento" value="{{ mov.idMovimento }}">
                                                        <input type="hidden" name="descricao_movimento" value="{{ mov.movimentoLocal.descricao if mov.movimentoLocal and mov.movimentoLocal.descricao else mov.descricao }}">
                                                        <button type="submit" class="btn btn-primary btn-sm">
                                                            <i class="fas fa-download"></i> Baixar
                                                        </button>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        Nenhum movimento com documentos vinculados encontrado.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

{# Dados JSON Brutos #}
<div class="row">
    <div class="col-md-12">
        <div class="card card-secondary collapsed-card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-code"></i> Dados Completos (JSON)
                </h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-tool" data-card-widget="collapse">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button type="button" class="btn btn-tool" onclick="copiarJSON()">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
            </div>
            <div class="card-body" style="display: none;">
                <pre id="resultadoJSON" class="code-block">{{ resultado | tojson(indent=2) }}</pre>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <a href="{{ url_for('index') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Voltar
        </a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Syntax highlighting simples para JSON
$(document).ready(function() {
    const pre = $('#resultadoJSON');
    if (pre.length) {
        let json = pre.text();
        json = json.replace(/(".*?")/g, '<span class="json-string">$1</span>');
        json = json.replace(/(\d+)/g, '<span class="json-number">$1</span>');
        json = json.replace(/(true|false|null)/g, '<span class="json-boolean">$1</span>');
        pre.html(json);
    }
});

// Função para copiar JSON
function copiarJSON() {
    const text = $('#resultadoJSON').text();
    navigator.clipboard.writeText(text).then(function() {
        Swal.fire({
            icon: 'success',
            title: 'Copiado!',
            text: 'JSON copiado para área de transferência',
            timer: 2000,
            showConfirmButton: false
        });
    });
}
</script>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
{% endblock %}